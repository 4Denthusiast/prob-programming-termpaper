% !TEX root = main.tex

\section{Introduction}
\label{sec:intro}

Various theorems about probabilistic programs rely on the assumption that the program terminates almost surely. One possible approach to prove almost sure termination is to find some variant on the program state that decreases on average sufficiently quickly that it must at some point reach 0, at which point the program terminates. In other words, the program's behavior is used to define an associated ranking supermartingale. Proof rules based on relating the program state to supermartingales already exist for first-order imperative programs \citep{DBLP:journals/pacmpl/McIverMKK18}. This paper's contribution is to extend this method to a higher-order setting.

The language PPCF used in this paper is simply typed, with an explicit recursion primitive, $\tY$. As the type system already constrains the terms enough to force termination in the absence of the recursion construct, it is only the $\tY$-reduction steps that must be counted, making defining ranking functions somewhat easier.

The notion of a sparse ranking function is introduced to make constructing ranking functions more convenient. Most of the individual execution steps of a typical program are trivial and easy to mentally skip over. Sparse ranking functions can be defined only for those points in the execution of a program which are semantically important, while all of the other intermediate steps can be ignored. This also makes the ranking function method of proving AST more compatible with syntactic sugar, because the intermediate reduction steps implicit in the simplified notation can be ignored.

A ranking function (or sparse ranking function) provides a bound on the expected number of $\tY$-reduction steps before the program terminates, therefore ranking functions cannot be constructed for terms whose expected number of $\tY$-reduction steps is infinite, such as the simplest implementation of the 1D unbiased random walk. This restriction can be removed by generalising ranking functions to antitone ranking functions, which rather than having to decrease by a constant amount for each $\tY$-reduction step, may decrease by a variable amount, depending on the value of the ranking function. This method is capable of proving the almost sure termination of programs which terminate arbitrarily slowly. Our progress condition is equivalent to that given in \citep{DBLP:journals/pacmpl/McIverMKK18} (by applying a transformation to the ranking function), but needs to be different in order to be compatible with the presence of additional intermediate reduction steps where the ranking function is not required to decrease at all.

Basic (non-random) lambda calculus has the very useful Church-Rosser property, which implies (among other things) that even if execution of a program starts in a different order, it will still reach the same normal form eventually (assuming it does reach a normal form). Probabilistic lambda calculus does not have this property, because random choices may be duplicated, and evaluating the same sub-term multiple times can yield different results. However, with a restricted set of reduction strategies, Church-Rosserness may be regained. A novel addressing scheme for the possible random choices in a program's execution is introduced, which ensures that the same random choices are taken at corresponding positions in alternative reduction sequences, so that the same eventual result can be reached. This is then used to prove yet another extension to the ranking function theorem, that ranking functions may be defined with respect to alternative reduction strategies (which in some cases may lead to a considerably simpler execution and ranking function), and rankability in this sense still imples almost sure termination. This confluent trace semantics has other possible applications as well, for example in Bayesian inference algorithms.

\subsubsection*{Contributions}

This is the first application of martingales to probabilistic lambda calculus, and the first version of sampling semantics that's capable of satisfying the (restricted) Church-Rosser property.
